<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>PROGRESS NEW VARIANT ENGP2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- XLSX dari CDN -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; background:#f9fafb; padding:20px; margin:0; }
    h1 { text-align:center; font-weight:bold; text-transform:uppercase; margin-bottom:20px; font-size:32px; }
    table { border-collapse:collapse; width:100%; background:#fff; }
    th, td { border:1px solid #ccc; padding:4px; text-align:center; vertical-align:middle; }
    th { background:#f1f1f1; }

    /* sticky header 2 baris */
    thead tr:first-child th {
      position: sticky;
      top: 0;
      z-index: 6;
      background:#f1f1f1;
    }
    thead tr:nth-child(2) th {
      position: sticky;
      top: 32px;
      z-index: 5;
      background:#f1f1f1;
    }

    .holiday { background:#fdd; color:#a00; }
    .group { position:relative; }
    .group select { position:absolute; inset:0; opacity:0; cursor:pointer; }
    .group:hover select { opacity:1; }
    .group div { color:#000; font-weight:bold; }
    .btn { padding:6px 10px; margin:2px; border:none; border-radius:6px; cursor:pointer; font-size:14px; }
    .blue { background:#2563eb; color:#fff; }
    .red { background:#dc2626; color:#fff; }
    .green { background:#16a34a; color:#fff; }
    .yellow { background:#ca8a04; color:#fff; }
    .purple { background:#7e22ce; color:#fff; }

    /* sticky kiri */
    .sticky-col, .sticky-col-2, .sticky-col-3 {
      position: sticky;
      background:#f9fafb;
      z-index: 7;
      box-shadow: 2px 0 3px rgba(0,0,0,0.1);
    }
    .sticky-col { left:0; }
    .sticky-col-2 { left:40px; }
    .sticky-col-3 { left:160px; }

    td input {
      width:100%; box-sizing:border-box; text-align:center;
      border:none; outline:none; background:transparent; font: inherit;
    }

    /* warna background tiap kode */
    .cell-PT   { background:#e0f2fe; font-weight:bold; }
    .cell-LTL  { background:#ede9fe; font-weight:bold; }
    .cell-SH   { background:#fef9c3; font-weight:bold; }
    .cell-HT   { background:#fee2e2; font-weight:bold; }
    .cell-PA   { background:#dcfce7; font-weight:bold; }
    .cell-AS   { background:#f3e8ff; font-weight:bold; }
    .cell-FG   { background:#cffafe; font-weight:bold; }
    .cell-ASS  { background:#fde68a; font-weight:bold; }
    .cell-D    { background:#bbf7d0; font-weight:bold; }

    /* highlight ISP kalau ada Delivery */
    .isp-delivered { background:#bbf7d0 !important; font-weight:bold; }
  </style>
</head>
<body>

<h1>PROGRESS NEW VARIANT ENGP2</h1>

<div>
  <button onclick="prevMonth()" class="btn">◀</button>
  <span id="monthLabel" style="font-weight:bold;"></span>
  <button onclick="nextMonth()" class="btn">▶</button>

  <button onclick="addRow()" class="btn blue">Tambah Baris</button>
  <button onclick="deleteLastRow()" class="btn red">Hapus Baris Terakhir</button>
  <button onclick="saveData()" class="btn green">Save</button>
  <button onclick="exportExcel()" class="btn yellow">Export Excel</button>
  <label class="btn purple">
    Import Excel
    <input type="file" id="importFile" style="display:none" onchange="importExcel(event)">
  </label>

  <button onclick="hideCheckedRows()" class="btn red">Hide Centang</button>
  <button onclick="unhideCheckedRows()" class="btn green">Unhide Centang</button>
</div>

<div style="overflow:auto; margin-top:10px; max-height:70vh;">
  <table id="scheduleTable" class="fit"></table>
</div>

<div id="hiddenList" style="margin-top:10px;"></div>

<p id="avgLeadtime" style="font-weight:bold; margin-top:10px;"></p>

<p><b>Note:</b> PT => Potong, LTL => Long Taper, SH => Shearing, HT => Heating, PA => Pre Assy, 
AS => Assy, FG => Finish Good, ASS => Assessment, D => Delivery</p>

<script>
// === script sama seperti versi Anda sebelumnya ===
const options = ["", "PT", "LTL", "SH", "HT", "PA", "AS", "FG", "ASS", "D"];
const holidays = new Set(["2025-01-01","2025-08-17"]);
let rows = Array.from({length:10}).map((_,i)=>({id:i+1, isp:"", qty:"", remark:"", leadtime:0, hidden:false}));
let data = {};
let currentMonth = new Date(new Date().getFullYear(), new Date().getMonth(),1);

// helper
function daysInMonth(y,m){return new Date(y,m+1,0).getDate();}
function formatDateKey(d){return d.toISOString().slice(0,10);}
function isSunday(d){return d.getDay()===0;}
function isHoliday(d){return holidays.has(formatDateKey(d));}
function twoDigit(n){return n.toString().padStart(2,'0');}

// checked rows
function getCheckedIds() {
  let ids = [];
  document.querySelectorAll(".row-check:checked").forEach(cb=>{
    ids.push(parseInt(cb.dataset.id));
  });
  return ids;
}
function restoreChecked(ids) {
  ids.forEach(id=>{
    let cb = document.querySelector(`.row-check[data-id="${id}"]`);
    if(cb) cb.checked = true;
  });
}

// render
function render(){
  let lastChecked = getCheckedIds();
  const table=document.getElementById("scheduleTable");
  table.innerHTML="";
  const year=currentMonth.getFullYear();
  const month=currentMonth.getMonth();
  const days=daysInMonth(year,month);
  const dates=Array.from({length:days}).map((_,i)=>new Date(year,month,i+1));
  document.getElementById("monthLabel").textContent=currentMonth.toLocaleString("default",{month:"long"})+" "+year;

  let thead=`<thead><tr>
  <th rowspan="2" class="sticky-col">Check</th>
  <th rowspan="2">No</th>
  <th rowspan="2" class="sticky-col-2">Isp Code</th>
  <th rowspan="2" class="sticky-col-3">Qty</th>
  <th rowspan="2">P/A</th>
  <th colspan="${days}">${currentMonth.toLocaleString("default",{month:"long"})+" "+year}</th>
  <th rowspan="2">Remark</th>
  <th rowspan="2">Lead Time</th>
  <th rowspan="2">Remove</th></tr><tr>`;
  dates.forEach(d=>{
    const cls=(isSunday(d)||isHoliday(d))?"holiday":"";
    thead+=`<th class="${cls} date-col">${twoDigit(d.getDate())}</th>`;
  });
  thead+="</tr></thead>";
  table.innerHTML+=thead;

  let tbody="<tbody>";
  rows.forEach(row=>{
    if(row.hidden) return;
    let count=0;
    if(data[row.id]){
      Object.values(data[row.id]).forEach(e=>{if(e.actual)count++;});
    }
    row.leadtime=count;

    let hasDelivery = Object.entries(data[row.id] || {}).some(([key, val])=>{
      const d=new Date(key);
      return d.getFullYear()===year && d.getMonth()===month && val.actual==="D";
    });
    let ispClass = hasDelivery ? "isp-delivered" : "";

    tbody+=`<tr>
    <td rowspan="2" class="sticky-col"><input type="checkbox" class="row-check" data-id="${row.id}"></td>
    <td rowspan="2">${row.id}</td>
    <td rowspan="2" class="sticky-col-2 ${ispClass}"><input value="${row.isp}" oninput="rows.find(r=>r.id==${row.id}).isp=this.value"></td>
    <td rowspan="2" class="sticky-col-3"><input type="number" value="${row.qty}" oninput="rows.find(r=>r.id==${row.id}).qty=this.value"></td>
    <td>Plan</td>`;
    dates.forEach(d=>{
      const key=formatDateKey(d);
      const val=data[row.id]?.[key]?.plan||"";
      const cls=(isSunday(d)||isHoliday(d))?"holiday":"";
      const colorCls=val?"cell-"+val:"";
      tbody+=`<td class="group date-col ${cls} ${colorCls}">
        <div>${val||"-"}</div>
        <select onchange="handleCellChange(${row.id},'${key}','plan',this.value)">`+options.map(o=>`<option ${o==val?"selected":""}>${o}</option>`).join("")+`</select>
      </td>`;
    });
    tbody+=`<td rowspan="2"><input value="${row.remark}" oninput="rows.find(r=>r.id==${row.id}).remark=this.value"></td>
    <td rowspan="2">${row.leadtime}</td>
    <td rowspan="2"><button onclick="deleteRow(${row.id})" class="btn red">X</button></td></tr>`;

    tbody+=`<tr><td>Actual</td>`;
    dates.forEach(d=>{
      const key=formatDateKey(d);
      const val=data[row.id]?.[key]?.actual||"";
      const cls=(isSunday(d)||isHoliday(d))?"holiday":"";
      const colorCls=val?"cell-"+val:"";
      tbody+=`<td class="group date-col ${cls} ${colorCls}">
        <div>${val||"-"}</div>
        <select onchange="handleCellChange(${row.id},'${key}','actual',this.value)">`+options.map(o=>`<option ${o==val?"selected":""}>${o}</option>`).join("")+`</select>
      </td>`;
    });
    tbody+="</tr>";
  });
  tbody+="</tbody>";
  table.innerHTML+=tbody;
  calculateAverageLeadtime();
  restoreChecked(lastChecked);

  let hiddenDiv = document.getElementById("hiddenList");
  let hiddenRows = rows.filter(r=>r.hidden);
  if(hiddenRows.length){
    hiddenDiv.innerHTML = "<b>Baris Tersembunyi:</b><br>" +
      hiddenRows.map(r=>`
        <label><input type="checkbox" class="hidden-check" data-id="${r.id}"> Row ${r.id} (ISP: ${r.isp || "-"})</label>
      `).join("<br>");
  } else hiddenDiv.innerHTML = "";
}

function calculateAverageLeadtime() {
  const year = currentMonth.getFullYear();
  const month = currentMonth.getMonth();
  let selected = [];
  rows.forEach(row => {
    const hasD = Object.entries(data[row.id] || {}).some(([key, val]) => {
      const d = new Date(key);
      return d.getFullYear() === year && d.getMonth() === month && val.actual === "D";
    });
    if (hasD) selected.push(row.leadtime);
  });
  if (selected.length) {
    const avg = (selected.reduce((a, b) => a + b, 0) / selected.length).toFixed(2);
    document.getElementById("avgLeadtime").textContent = "Lead Time Average (Delivery) : " + avg;
  } else document.getElementById("avgLeadtime").textContent = "Lead Time Average (Delivery) : -";
}

function handleCellChange(rowId,dateKey,type,val){
  if(!data[rowId])data[rowId]={};
  if(!data[rowId][dateKey])data[rowId][dateKey]={};
  data[rowId][dateKey][type]=val;
  render();
}
function addRow(){const id=rows.length?Math.max(...rows.map(r=>r.id))+1:1;rows.push({id,isp:"",qty:"",remark:"",leadtime:0,hidden:false});render();}
function deleteRow(id){rows=rows.filter(r=>r.id!=id); delete data[id]; render();}
function deleteLastRow(){if(rows.length){deleteRow(rows[rows.length-1].id);} }
function prevMonth(){currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()-1,1); render();}
function nextMonth(){currentMonth=new Date(currentMonth.getFullYear(),currentMonth.getMonth()+1,1); render();}
function saveData(){localStorage.setItem("scheduleData",JSON.stringify({rows,data,currentMonth}));alert("Data tersimpan!");}

// hide/unhide
function hideCheckedRows(){
  let ids = getCheckedIds();
  ids.forEach(id=>{let r = rows.find(r=>r.id===id); if(r && !r.hidden){ r.hidden = true; }});
  render();
}
function unhideCheckedRows(){
  let ids = getCheckedIds();
  document.querySelectorAll(".hidden-check:checked").forEach(cb=>{ids.push(parseInt(cb.dataset.id));});
  ids.forEach(id=>{let r = rows.find(r=>r.id===id); if(r && r.hidden){ r.hidden = false; }});
  render();
}

// excel export
function exportExcel(){
  const wb = XLSX.utils.book_new();
  const year=currentMonth.getFullYear();
  const month=currentMonth.getMonth();
  const days=daysInMonth(year,month);
  let header1=["Check","No","ISP Code","Qty","P/A"];
  for(let d=1; d<=days; d++) header1.push(twoDigit(d));
  header1.push("Remark","Lead Time","Remove");

  let aoa=[header1];
  rows.forEach(r=>{
    if(r.hidden) return;
    let line=[null,r.id,r.isp,r.qty,"Plan"];
    for(let d=1; d<=days; d++){
      let key=formatDateKey(new Date(year,month,d));
      line.push(data[r.id]?.[key]?.plan||"");
    }
    line.push(r.remark,r.leadtime,"X");
    aoa.push(line);

    let line2=[null,null,null,null,"Actual"];
    for(let d=1; d<=days; d++){
      let key=formatDateKey(new Date(year,month,d));
      line2.push(data[r.id]?.[key]?.actual||"");
    }
    line2.push(null,null,null);
    aoa.push(line2);
  });

  const ws = XLSX.utils.aoa_to_sheet(aoa);
  XLSX.utils.book_append_sheet(wb, ws, "Schedule");
  XLSX.writeFile(wb,"schedule.xlsx");
}

// import excel
function importExcel(ev){
  const file=ev.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const wb=XLSX.read(new Uint8Array(e.target.result),{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rowsX = XLSX.utils.sheet_to_json(ws,{header:1});
    rows=[]; data={};
    for(let i=1;i<rowsX.length;i+=2){
      const row=rowsX[i];
      if(!row || !row[2]) continue;
      let id=rows.length+1;
      rows.push({id,isp:row[2],qty:row[3],remark:row[row.length-3],leadtime:0,hidden:false});
      data[id]={};
      const baseCols=5;
      const days=(row.length-baseCols-3);
      for(let d=1; d<=days; d++){
        const key=formatDateKey(new Date(currentMonth.getFullYear(),currentMonth.getMonth(),d));
        data[id][key]={plan:row[baseCols+d-1]||"",actual:rowsX[i+1][baseCols+d-1]||""};
      }
    }
    render();
  };
  reader.readAsArrayBuffer(file);
}

// load
const saved=localStorage.getItem("scheduleData");
if(saved){
  const parsed=JSON.parse(saved);
  rows=parsed.rows; data=parsed.data; currentMonth=new Date(parsed.currentMonth);
}
render();
</script>

</body>
</html>